// Copyright 2023 Sean Luke
// (sean@cs.gmu.edu)
//
// Released under the Apache 2.0 License
//
// WARNING: Mozzi itself is released under a broken non-open-source license, namely the 
// Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
// This license is not compatible with the LGPL (used by the Arduino itself!) and is
// also viral, AND is non-commercial only.  What a mess.  I am pushing them to change 
// their license to something reasonable like Apache or GPL but in the meantime I don't 
// have much choice but to turn my head and ignore the broken license.  So I'm releasing
// under Apache for the time being.


/// Droplets
///
/// Droplets produces a tinkly chord of sine waves, like a wind chime.
/// Droplets is meant to run on the AE Modular GRAINS, but it could be adapted to any Arduino.
///
/// The tinkling is done by choosing a chord from POT 3.  You can then specify the degree of tinkle
/// (release) with POT 2.  Then every time you trigger Droplets it will issue one tinkle.  
///
/// SET GRAINS TO MOZZI MODE.  Sorry, no Grains mode.
///
/// You will need to install the Mozzi Library.  You can do this from the Library Manager
/// in your Arduino IDE.
///
///
/// CHOICE OF DROPLET CHORD
///
/// You current choices are (in order left to right): Maj, min, Maj7, min7, 7, dim7, Aug7, 5+Oct, 
/// Oct, Pentatonic, Whole Tone, and Chromatic.  Except for Whole Tone and Chromatic, most droplet 
/// chords range 3 or 4 octaves, with an emphasis on the fundamental.

///
///
/// RELEASE AND VOLUME
///
/// One potentiometer controls both the length of release of the individual tinkles and their volume.
/// Left to right, you have three broad regions: low volume, medium volume, and high volume.
/// Within a region, you have five levels of release from fast release to long release.  Why would
/// you want lower volume?  Because longer release tinkles, depending on the chord, will cause the
/// sine waves to overlap and add up to the point that they cause clipping.
///
///
/// NOISE
/// 
/// This program is pretty hissy.  Most of the problem is due to Mozzi I'm afraid.


/// ADJUSTING TUNING AND TRACKING
///
/// Grains's Inputs track 1.3V/octave, not 1V/octave: we'll need to scale them to track properly.  
/// To do this, you can adjust the Pitch CV Scaling on Pot 1.  This GRAINS program is set up to play 
/// the C two octaves below Middle C when it receives 0V.  You should be able to use Pot 1 to scale 
/// the pitch such that high Cs play in tune as well.  Once you have things tracking well, you can 
/// then use the Pitch Tune (Audio In) to tune 0V to some other note.  Note that as GRAINS resistors 
/// warm up, the scaling will change and you will need to adjust the tracking again, at least until 
/// they are fully warmed up.
///
/// By default the note corresponding to 0V is C0, three notes below middle C, that is MIDI note 24, 
/// or 32.7 Hz.  You can customize the tuning for this Grains program but only UP.  This can be done 
/// in two ways.  First, you can add pitch to the tuning with a CV value to Audio In.  Second, you 
/// can transpose the pitch up by changing the TRANSPOSE_OCTAVES and/or TRANSPOSE_SEMITONES #defines 
/// in the code to positive integers.
///
/// I recognize that Droplets will be hard to tune because of the tinkles.  By far the easiest to tune 
/// with is OCTAVES, which is the very last droplet option (turn the droplet knob fully to the right).


/// CONFIGURATION
///
/// IN 1            Pitch CV
/// IN 2            Release and Volume CV
/// IN 3            Trigger
/// AUDIO IN (A)    Pitch Tune
/// AUDIO OUT       Out
/// DIGITAL OUT (D) [Unused]
///
/// POT 1           Pitch Scaling	[Set the switch to In1]
///
/// POT 2           Release and Volume
///
/// POT 3           Choice of Droplets



PROGMEM const float frequencies[1024+512] = {
32.7, 32.81097, 32.922318, 33.034042, 33.146145, 33.25863, 33.37149, 33.48474, 33.59837, 33.71239, 33.826794, 33.94159, 34.056774, 34.172344, 34.28831, 34.40467, 
34.521423, 34.638577, 34.756123, 34.87407, 34.992416, 35.111168, 35.23032, 35.349876, 35.469837, 35.590206, 35.710987, 35.832172, 35.95377, 36.075783, 36.198208, 36.32105, 
36.444305, 36.56798, 36.692078, 36.816593, 36.941532, 37.066895, 37.192684, 37.3189, 37.445545, 37.572617, 37.700123, 37.82806, 37.956432, 38.08524, 38.214485, 38.34417, 
38.47429, 38.60486, 38.735863, 38.867317, 38.999214, 39.131565, 39.26436, 39.397606, 39.531303, 39.665455, 39.80006, 39.935123, 40.070644, 40.20663, 40.34307, 40.47998, 
40.617348, 40.755188, 40.893494, 41.03227, 41.171513, 41.31123, 41.451424, 41.59209, 41.733234, 41.874863, 42.016968, 42.159554, 42.302628, 42.446182, 42.59022, 42.73476, 
42.87978, 43.025295, 43.171303, 43.317806, 43.46481, 43.612312, 43.760315, 43.908817, 44.057823, 44.207336, 44.357357, 44.507885, 44.658924, 44.81048, 44.962543, 45.115128, 
45.26823, 45.421852, 45.575993, 45.73066, 45.885845, 46.04156, 46.197807, 46.354584, 46.511887, 46.66973, 46.828106, 46.987022, 47.146477, 47.30647, 47.467007, 47.62809, 
47.78972, 47.951893, 48.11462, 48.277905, 48.44174, 48.60613, 48.771072, 48.93658, 49.102654, 49.269283, 49.43648, 49.604248, 49.772583, 49.94149, 50.11097, 50.281025, 
50.451656, 50.622868, 50.79466, 50.967033, 51.13999, 51.31354, 51.487675, 51.6624, 51.83772, 52.013634, 52.190147, 52.36726, 52.544968, 52.723286, 52.902206, 53.08173, 
53.261868, 53.44261, 53.623974, 53.80595, 53.988544, 54.171757, 54.355595, 54.540054, 54.725136, 54.91085, 55.097195, 55.28417, 55.47178, 55.660027, 55.848915, 56.038437, 
56.228607, 56.419422, 56.61089, 56.803, 56.99576, 57.189182, 57.38326, 57.57799, 57.773384, 57.96944, 58.166164, 58.363556, 58.561615, 58.76035, 58.95976, 59.15984, 
59.360603, 59.562046, 59.764175, 59.966988, 60.17049, 60.374683, 60.579563, 60.785145, 60.991425, 61.198402, 61.406086, 61.614468, 61.82356, 62.033363, 62.243877, 62.455105, 
62.667053, 62.879715, 63.093098, 63.307213, 63.52205, 63.737614, 63.95391, 64.170944, 64.38871, 64.607216, 64.82647, 65.04646, 65.2672, 65.488686, 65.71092, 65.93392, 
66.15767, 66.38218, 66.60745, 66.83349, 67.06029, 67.287865, 67.51621, 67.74534, 67.975235, 68.20591, 68.43737, 68.66962, 68.90265, 69.136475, 69.37109, 69.606514, 
69.84273, 70.07974, 70.31756, 70.55618, 70.79562, 71.03587, 71.27694, 71.518814, 71.76152, 72.00505, 72.249405, 72.49458, 72.7406, 72.98745, 73.23514, 73.483665, 
73.73304, 73.98325, 74.23433, 74.48624, 74.73901, 74.992645, 75.24714, 75.502495, 75.75872, 76.01581, 76.27377, 76.53261, 76.79233, 77.052925, 77.314415, 77.57678, 
77.84005, 78.1042, 78.36925, 78.63521, 78.902054, 79.169815, 79.438484, 79.70806, 79.97856, 80.24997, 80.52231, 80.795555, 81.06975, 81.34486, 81.62091, 81.897896, 
82.17582, 82.45468, 82.734505, 83.01527, 83.29699, 83.57966, 83.8633, 84.14788, 84.43345, 84.71997, 85.00748, 85.29596, 85.58542, 85.875854, 86.167274, 86.459694, 
86.7531, 87.0475, 87.3429, 87.63931, 87.936714, 88.23513, 88.53457, 88.835014, 89.136475, 89.43897, 89.742485, 90.04703, 90.352615, 90.65923, 90.96689, 91.27559, 
91.585335, 91.89614, 92.208, 92.52091, 92.83488, 93.14992, 93.466034, 93.78321, 94.10147, 94.420815, 94.741234, 95.062744, 95.38535, 95.709045, 96.03384, 96.35974, 
96.68674, 97.014854, 97.34407, 97.674416, 98.00588, 98.33848, 98.672195, 99.007034, 99.343025, 99.68015, 100.018425, 100.35785, 100.69841, 101.04014, 101.383026, 101.72707, 
102.072296, 102.418686, 102.76624, 103.11499, 103.46492, 103.81603, 104.168335, 104.521835, 104.87654, 105.232445, 105.58956, 105.94788, 106.30742, 106.66818, 107.03017, 107.39338, 
107.75783, 108.12351, 108.49043, 108.858604, 109.22803, 109.598694, 109.97062, 110.34382, 110.71828, 111.094, 111.47101, 111.8493, 112.22886, 112.60971, 112.99186, 113.375305, 
113.760056, 114.1461, 114.53347, 114.92215, 115.31214, 115.70346, 116.0961, 116.49008, 116.8854, 117.28206, 117.68006, 118.079414, 118.480125, 118.882195, 119.28563, 119.69043, 
120.09661, 120.504166, 120.9131, 121.323425, 121.73515, 122.14826, 122.56278, 122.97871, 123.39604, 123.8148, 124.23497, 124.65657, 125.0796, 125.50407, 125.92997, 126.35732, 
126.78612, 127.21638, 127.64809, 128.08127, 128.51593, 128.95204, 129.38965, 129.82875, 130.26933, 130.71141, 131.15498, 131.60007, 132.04666, 132.49478, 132.9444, 133.39555, 
133.84824, 134.30246, 134.75822, 135.21555, 135.6744, 136.13481, 136.59679, 137.06035, 137.52547, 137.99217, 138.46046, 138.93033, 139.40181, 139.87486, 140.34953, 140.82582, 
141.30373, 141.78326, 142.2644, 142.7472, 143.2316, 143.71767, 144.2054, 144.69475, 145.18579, 145.67848, 146.17285, 146.6689, 147.16663, 147.66605, 148.16716, 148.66997, 
149.1745, 149.68073, 150.18869, 150.69836, 151.20976, 151.7229, 152.23778, 152.75441, 153.27278, 153.79292, 154.31483, 154.83852, 155.36397, 155.8912, 156.42023, 156.95105, 
157.48367, 158.01811, 158.55435, 159.0924, 159.6323, 160.17403, 160.71759, 161.26299, 161.81024, 162.35936, 162.91034, 163.46318, 164.0179, 164.57451, 165.133, 165.69339, 
166.25568, 166.81989, 167.38599, 167.95403, 168.52399, 169.09589, 169.66972, 170.24551, 170.82324, 171.40294, 171.9846, 172.56825, 173.15387, 173.74149, 174.33109, 174.92268, 
175.5163, 176.11192, 176.70956, 177.30923, 177.91096, 178.51471, 179.1205, 179.72836, 180.33829, 180.95027, 181.56433, 182.18048, 182.79874, 183.41907, 184.0415, 184.66606, 
185.29276, 185.92155, 186.55247, 187.18556, 187.82079, 188.45816, 189.09772, 189.73943, 190.38332, 191.0294, 191.67766, 192.32814, 192.9808, 193.6357, 194.29282, 194.95216, 
195.61374, 196.27757, 196.94365, 197.61198, 198.2826, 198.95547, 199.63065, 200.3081, 200.98785, 201.66992, 202.35431, 203.04102, 203.73004, 204.42142, 205.11514, 205.8112, 
206.50964, 207.21043, 207.91362, 208.6192, 209.32715, 210.0375, 210.75029, 211.46548, 212.1831, 212.90317, 213.62566, 214.35062, 215.07803, 215.8079, 216.54027, 217.2751, 
218.01244, 218.75227, 219.49463, 220.2395, 220.9869, 221.73682, 222.4893, 223.24432, 224.00192, 224.7621, 225.52484, 226.29016, 227.0581, 227.82864, 228.60178, 229.37756, 
230.15598, 230.93703, 231.72072, 232.50706, 233.2961, 234.08781, 234.88219, 235.67928, 236.47908, 237.28157, 238.0868, 238.89478, 239.70547, 240.51894, 241.33514, 242.15413, 
242.97589, 243.80046, 244.62779, 245.45796, 246.29094, 247.12674, 247.96538, 248.80687, 249.65121, 250.49841, 251.3485, 252.20146, 253.05731, 253.91609, 254.77777, 255.64238, 
256.50992, 257.3804, 258.2538, 259.13025, 260.0096, 260.89197, 261.7773, 262.66568, 263.55707, 264.45145, 265.34888, 266.24933, 267.1529, 268.05948, 268.96915, 269.88193, 
270.7978, 271.71674, 272.63882, 273.56406, 274.4924, 275.42392, 276.3586, 277.29642, 278.23743, 279.18167, 280.1291, 281.0797, 282.03357, 282.9907, 283.95102, 284.91464, 
285.8815, 286.85165, 287.82513, 288.80188, 289.71024, 290.76532, 291.75204, 292.74213, 293.7356, 294.7324, 295.7326, 296.73615, 297.74316, 298.75357, 299.76743, 300.78467, 
301.8054, 302.82962, 303.8573, 304.88843, 305.9231, 306.96127, 308.00296, 309.0482, 310.097, 311.1493, 312.20517, 313.2647, 314.32776, 315.39444, 316.46475, 317.53873, 
318.61627, 319.69754, 320.78244, 321.87106, 322.96335, 324.05936, 325.15906, 326.26248, 327.3697, 328.48065, 329.59537, 330.71384, 331.83618, 332.96228, 334.0922, 335.22595, 
336.36356, 337.50504, 338.65036, 339.79962, 340.95273, 342.10977, 343.27072, 344.43567, 345.60455, 346.77734, 347.95416, 349.13498, 350.31976, 351.5086, 352.70148, 353.89838, 
355.09937, 356.3044, 357.51355, 358.7268, 359.94415, 361.16565, 362.3913, 363.6211, 364.85507, 366.0932, 367.33557, 368.58215, 369.83298, 371.088, 372.34732, 373.6109, 
374.87878, 376.15094, 377.42746, 378.70825, 379.99344, 381.28296, 382.57687, 383.87518, 385.17786, 386.485, 387.79654, 389.11258, 390.43304, 391.758, 393.08746, 394.42142, 
395.75992, 397.10294, 398.45056, 399.8027, 401.1595, 402.52084, 403.8868, 405.25742, 406.6327, 408.01263, 409.39722, 410.78656, 412.1806, 413.57935, 414.98285, 416.3911, 
417.80417, 419.22202, 420.64468, 422.07214, 423.5045, 424.94168, 426.38376, 427.83072, 429.28256, 430.73938, 432.20108, 433.66782, 435.13947, 436.61615, 438.09784, 439.58453, 
441.07632, 442.57312, 444.075, 445.582, 447.09412, 448.61136, 450.13376, 451.66132, 453.19406, 454.73203, 456.27515, 457.82355, 459.3772, 460.93616, 462.50037, 464.0699, 
465.6447, 467.2249, 468.8105, 470.4014, 471.99774, 473.5995, 475.2067, 476.81934, 478.43744, 480.06107, 481.6902, 483.3248, 484.96503, 486.61075, 488.26212, 489.91907, 
491.58163, 493.24985, 494.9237, 496.60327, 498.28854, 499.9795, 501.6762, 503.37866, 505.0869, 506.80096, 508.5208, 510.24652, 511.97806, 513.7155, 515.4588, 517.20807, 
518.96326, 520.72437, 522.49146, 524.2646, 526.0437, 527.82886, 529.6201, 531.4174, 533.2208, 535.0303, 536.84595, 538.6678, 540.4958, 542.32996, 544.1704, 546.01715, 
547.87, 549.7293, 551.59485, 553.4667, 555.3449, 557.2295, 559.1205, 561.01794, 562.9218, 564.8321, 566.7489, 568.6721, 570.602, 572.5383, 574.4813, 576.43085, 
578.387, 580.3498, 582.3193, 584.2954, 586.2782, 588.26776, 590.2641, 592.2672, 594.2771, 596.2938, 598.3174, 600.3478, 602.3851, 604.4293, 606.4805, 608.5387, 
610.60376, 612.6759, 614.75507, 616.84125, 618.9346, 621.0349, 623.14246, 625.2571, 627.3789, 629.508, 631.6443, 633.7878, 635.93866, 638.09674, 640.26215, 642.4349, 
644.61505, 646.8026, 648.99756, 651.19995, 653.40985, 655.62726, 657.8521, 660.0846, 662.32465, 664.57227, 666.8275, 669.09045, 671.361, 673.63934, 675.9254, 678.21924, 
680.5208, 682.8302, 685.1474, 687.4725, 689.8054, 692.14636, 694.4952, 696.85205, 699.2168, 701.58966, 703.9705, 706.3595, 708.7566, 711.16174, 713.5752, 715.9967, 
718.42645, 720.86456, 723.31085, 725.7654, 728.22833, 730.69965, 733.1793, 735.6674, 738.16394, 740.66895, 743.18243, 745.7045, 748.23505, 750.7743, 753.322, 755.87854, 
758.44366, 761.01746, 763.6, 766.19135, 768.79144, 771.4004, 774.0182, 776.64484, 779.28046, 781.925, 784.5785, 787.241, 789.9126, 792.5932, 795.2829, 797.98175, 
800.6897, 803.4069, 806.13336, 808.869, 811.61395, 814.3682, 817.13184, 819.90485, 822.68726, 825.47906, 828.28033, 831.0912, 833.9115, 836.74146, 839.581, 842.4302, 
845.289, 848.15753, 851.0358, 853.9238, 856.8217, 859.7294, 862.647, 865.57434, 868.5118, 871.4591, 874.4165, 877.38385, 880.3613, 883.3488, 886.34656, 889.35443, 
892.3725, 895.4008, 898.4394, 901.4883, 904.54755, 907.61725, 910.69727, 913.7878, 916.8888, 920.0003, 923.1224, 926.25507, 929.3983, 932.5523, 935.717, 938.8924, 
942.0786, 945.27563, 948.48346, 951.7022, 954.9319, 958.1725, 961.42413, 964.68677, 967.96045, 971.2453, 974.54126, 977.84845, 981.1668, 984.4965, 987.8374, 991.1897, 
994.55334, 997.92847, 1001.31494, 1004.713, 1008.12256, 1011.5437, 1014.97644, 1018.42084, 1021.8769, 1025.3447, 1028.8242, 1032.3157, 1035.8188, 1039.334, 1042.861, 1046.4, 
1049.951, 1053.5142, 1057.0894, 1060.6766, 1064.2761, 1067.8877, 1071.5117, 1075.1478, 1078.7965, 1082.4574, 1086.1309, 1089.8168, 1093.515, 1097.226, 1100.9495, 1104.6855, 
1108.4344, 1112.1959, 1115.9702, 1119.7573, 1123.5574, 1127.3702, 1131.196, 1135.0348, 1138.8866, 1142.7516, 1146.6295, 1150.5206, 1154.425, 1158.3427, 1162.2736, 1166.2178, 
1170.1754, 1174.1465, 1178.131, 1182.129, 1186.1406, 1190.1659, 1194.2048, 1198.2574, 1202.3237, 1206.4039, 1210.4979, 1214.6058, 1218.7277, 1222.8635, 1227.0134, 1231.1772, 
1235.3555, 1239.5476, 1243.7542, 1247.9749, 1252.2101, 1256.4595, 1260.7234, 1265.0017, 1269.2946, 1273.6019, 1277.924, 1282.2606, 1286.6122, 1290.9783, 1295.3594, 1299.7551, 
1304.166, 1308.5918, 1313.0326, 1317.4884, 1321.9594, 1326.4456, 1330.9469, 1335.4635, 1339.9956, 1344.543, 1349.1057, 1353.6841, 1358.2778, 1362.8871, 1367.5123, 1372.153, 
1376.8094, 1381.4817, 1386.1698, 1390.8739, 1395.594, 1400.3301, 1405.0822, 1409.8503, 1414.6348, 1419.4354, 1424.2523, 1429.0856, 1433.9353, 1438.8014, 1443.6841, 1448.5834, 
1453.4993, 1458.4318, 1463.3811, 1468.347, 1473.33, 1478.3298, 1483.3467, 1488.3804, 1493.4314, 1498.4994, 1503.5847, 1508.6873, 1513.807, 1518.9442, 1524.0989, 1529.271, 
1534.4606, 1539.6678, 1544.893, 1550.1356, 1555.3961, 1560.6743, 1565.9706, 1571.2849, 1576.6171, 1581.9674, 1587.3359, 1592.7227, 1598.1277, 1603.551, 1608.9928, 1614.453, 
1619.9318, 1625.4291, 1630.9451, 1636.4797, 1642.0333, 1647.6056, 1653.1968, 1658.807, 1664.4363, 1670.0847, 1675.7523, 1681.439, 1687.1451, 1692.8706, 1698.6154, 1704.3798, 
1710.1636, 1715.9672, 1721.7904, 1727.6334, 1733.4962, 1739.379, 1745.2817, 1751.2043, 1757.1472, 1763.1102, 1769.0934, 1775.0969, 1781.1208, 1787.1653, 1793.23, 1799.3154, 
1805.4215, 1811.5485, 1817.696, 1823.8644, 1830.0538, 1836.2643, 1842.4957, 1848.7483, 1855.0221, 1861.3173, 1867.6338, 1873.9717, 1880.3312, 1886.7123, 1893.1149, 1899.5393, 
1905.9855, 1912.4536, 1918.9436, 1925.4557, 1931.9899, 1938.546, 1945.1246, 1951.7256, 1958.3489, 1964.9948, 1971.663, 1978.3539, 1985.0676, 1991.8041, 1998.5634, 2005.3457, 
2012.1509, 2018.9791, 2025.8308, 2032.7056, 2039.6036, 2046.5251, 2053.4702, 2060.4387, 2067.431, 2074.447, 2081.4868, 2088.5503, 2095.638, 2102.7495, 2109.8855, 2117.0454, 
2124.2297, 2131.4385, 2138.6716, 2145.9292, 2153.2117, 2160.5188, 2167.8508, 2175.2075, 2182.589, 2189.9958, 2197.4277, 2204.8848, 2212.3672, 2219.875, 2227.4084, 2234.9673, 
2242.5518, 2250.1619, 2257.7979, 2265.46, 2273.148, 2280.862, 2288.602, 2296.3687, 2304.1616, 2311.981, 2319.8267, 2327.6992, 2335.5984, 2343.5244, 2351.4773, 2359.4573, 
2367.464, 2375.4985, 2383.5596, 2391.6484, 2399.7646, 2407.9084, 2416.0798, 2424.279, 2432.5059, 2440.7607, 2449.0435, 2457.3545, 2465.6936, 2474.0613, 2482.457, 2490.8816, 
2499.3345, 2507.816, 2516.3267, 2524.8657, 2533.434, 2542.0315, 2550.658, 2559.314, 2567.999, 2576.7139, 2585.4578, 2594.232, 2603.0354, 2611.8691, 2620.7327, 2629.6262, 
2638.5498, 2647.5042, 2656.4885, 2665.5037, 2674.549, 2683.6255, 2692.7322, 2701.8704, 2711.039, 2720.2393, 2729.4707, 2738.7334, 2748.0273, 2757.3528, 2766.7102, 2776.099, 
2785.52, 2794.973, 2804.458, 2813.9749, 2823.5242, 2833.1062, 2842.7205, 2852.3672, 2862.047, 2871.7595, 2881.505, 2891.2837, 2901.0955, 2910.9404, 2920.8188, 2930.7307, 
2940.6765, 2950.656, 2960.6692, 2970.716, 2980.7974, 2990.913, 3001.0627, 3011.247, 3021.466, 3031.7195, 3042.0078, 3052.3313, 3062.6895, 3073.0828, 3083.5117, 3093.9756, 
3104.4753, 3115.0103, 3125.5813, 3136.1882, 3146.8313, 3157.5103, 3168.225, 3178.9768, 3189.765, 3200.5896, 3211.4512, 3222.349, 3233.2844, 3244.2568, 3255.2664, 3266.3135, 
3277.398, 3288.5198, 3299.6797, 3310.8774, 3322.113, 3333.3867, 3344.6987, 3356.0493, 3367.4382, 3378.866, 3390.3323, 3401.8374, 3413.3818, 3424.9653, 3436.5881, 3448.2505, 
3459.9524, 3471.6938, 3483.4753, 3495.2969, 3507.1582, 3519.0598, 3531.0022, 3542.9849, 3555.008, 3567.0723, 3579.1775, 3591.3235, 3603.5107, 3615.7395, 3628.0098, 3640.3218, 
3652.6753, 3665.071, 3677.5088, 3689.9885, 3702.5107, 3715.0752, 3727.6826, 3740.3328, 3753.026, 3765.762, 3778.5413, 3791.364, 3804.2302, 3817.1401, 3830.0938, 3843.0916, 
3856.1333, 3869.2192, 3882.3496, 3895.525, 3908.7444, 3922.009, 3935.3186, 3948.6733, 3962.0735, 3975.519, 3989.0103, 4002.547, 4016.1301, 4029.759, 4043.4343, 4057.1558, 
4070.924, 4084.7388, 4098.6006, 4112.51, 4126.4653, 4140.4688, 4154.52, 4168.6187, 4182.765, 4196.9595, 4211.202, 4225.493, 4239.833, 4254.2207, 4268.6577, 4283.1436, 
4297.6787, 4312.263, 4326.8975, 4341.5806, 4356.314, 4371.097, 4385.931, 4400.815, 4415.7495, 4430.735, 4445.7705, 4460.858, 4475.9956, 4491.185, 4506.4263, 4521.719, 
4537.0645, 4552.461, 4567.91, 4583.411, 4598.9653, 4614.5728, 4630.232, 4645.9453, 4661.7114, 4677.5313, 4693.405, 4709.332, 4725.3135, 4741.349, 4757.439, 4773.584, 
4789.783, 4806.038, 4822.3477, 4838.7124, 4855.133, 4871.609, 4888.141, 4904.729, 4921.3735, 4938.0747, 4954.8325, 4971.647, 4988.5186, 5005.4473, 5022.4336, 5039.4775, 
5056.5796, 5073.7393, 5090.957, 5108.2334, 5125.569, 5142.963, 5160.4155, 5177.9277, 5195.4995, 5213.131, 5230.822, 5248.5728, 5266.3843, 5284.256, 5302.1885, 5320.1816, 
5338.2363, 5356.3516, 5374.529, 5392.7676, 5411.0684, 5429.431, 5447.8564, 5466.3438, 5484.894, 5503.5073, 5522.184, 5540.924, 5559.7275, 5578.5947, 5597.526, 5616.5215, 
5635.5815, 5654.706, 5673.8955, 5693.151, 5712.4707, 5731.856, 5751.3076, 5770.825, 5790.4087, 5810.0586, 5829.7754, 5849.5596, 5869.41, 5889.328, 5909.314, 5929.368, 
};


float rates[256] = {
// 0., 0.00981045, 0.0197171, 0.029721, 0.039823, 0.0500242, 0.0603254, 
// 0.0707276, 0.081232, 0.0918393, 0.102551, 0.113367, 0.12429, 0.13532, 
// 0.146458, 0.157705, 0.169063, 0.180532, 0.192113, 0.203808, 0.215618, 
// 0.227544, 0.239587, 0.251748, 0.264028, 0.276428, 0.288951, 0.301596, 
// 0.314365, 0.32726, 0.340281, 0.353429,
//0.366707, 0.380115, 0.393655, 
//0.407327, 0.421134, 0.435076, 0.449154, 0.463371, 0.477728, 0.492225, 
//0.506864, 0.521647, 0.536575, 0.55165, 0.566872, 0.582244, 0.597766, 
//0.613441, 0.62927, 0.645253, 0.661394, 0.677693, 0.694152, 0.710772, 
//0.727556, 0.744504, 0.761618, 0.778901, 0.796352, 0.813975, 0.831771, 
//0.849742,

0.0, 0.900981, 0.901972, 0.902972, 0.903982, 0.905002, 0.906033, 
0.907073, 0.908123, 0.909184, 0.910255, 0.911337, 0.912429, 0.913532, 
0.914646, 0.91577, 0.916906, 0.918053, 0.919211, 0.920381, 0.921562, 
0.922754, 0.923959, 0.925175, 0.926403, 0.927643, 0.928895, 0.93016, 
0.931437, 0.932726, 0.934028, 0.935343, 0.936671, 0.938012, 0.939365, 
0.940733, 0.942113, 0.943508, 0.944915, 0.946337, 0.947773, 0.949222, 
0.950686, 0.952165, 0.953658, 0.955165, 0.956687, 0.958224, 0.959777, 
0.961344, 0.962927, 0.964525, 0.966139, 0.967769, 0.969415, 0.971077, 
0.972756, 0.97445, 0.976162, 0.97789, 0.979635, 0.981398, 0.983177, 
0.984974,

0.99, 0.990098, 0.990197, 0.990297, 0.990398, 0.9905, 0.990603, 
0.990707, 0.990812, 0.990918, 0.991026, 0.991134, 0.991243, 0.991353, 
0.991465, 0.991577, 0.991691, 0.991805, 0.991921, 0.992038, 0.992156, 
0.992275, 0.992396, 0.992517, 0.99264, 0.992764, 0.99289, 0.993016, 
0.993144, 0.993273, 0.993403, 0.993534, 0.993667, 0.993801, 0.993937, 
0.994073, 0.994211, 0.994351, 0.994492, 0.994634, 0.994777, 0.994922, 
0.995069, 0.995216, 0.995366, 0.995516, 0.995669, 0.995822, 0.995978, 
0.996134, 0.996293, 0.996453, 0.996614, 0.996777, 0.996942, 0.997108, 
0.997276, 0.997445, 0.997616, 0.997789, 0.997964, 0.99814, 0.998318, 
0.998497,

0.999, 0.99901, 0.99902, 0.99903, 0.99904, 0.99905, 0.99906, 
0.999071, 0.999081, 0.999092, 0.999103, 0.999113, 0.999124, 0.999135, 
0.999146, 0.999158, 0.999169, 0.999181, 0.999192, 0.999204, 0.999216, 
0.999228, 0.99924, 0.999252, 0.999264, 0.999276, 0.999289, 0.999302, 
0.999314, 0.999327, 0.99934, 0.999353, 0.999367, 0.99938, 0.999394, 
0.999407, 0.999421, 0.999435, 0.999449, 0.999463, 0.999478, 0.999492, 
0.999507, 0.999522, 0.999537, 0.999552, 0.999567, 0.999582, 0.999598, 
0.999613, 0.999629, 0.999645, 0.999661, 0.999678, 0.999694, 0.999711, 
0.999728, 0.999745, 0.999762, 0.999779, 0.999796, 0.999814, 0.999832, 
0.99985,

0.9999, 0.999901, 0.999902, 0.999903, 0.999904, 0.999905, 0.999906, 
0.999907, 0.999908, 0.999909, 0.99991, 0.999911, 0.999912, 0.999914, 
0.999915, 0.999916, 0.999917, 0.999918, 0.999919, 0.99992, 0.999922, 
0.999923, 0.999924, 0.999925, 0.999926, 0.999928, 0.999929, 0.99993, 
0.999931, 0.999933, 0.999934, 0.999935, 

0.999937, 0.999938, 0.999939, 
0.999941, 0.999942, 0.999944, 0.999945, 0.999946, 0.999948, 0.999949, 
0.999951, 0.999952, 0.999954, 0.999955, 0.999957, 0.999958, 0.99996, 
0.999961, 0.999963, 0.999965, 0.999966, 0.999968, 0.999969, 0.999971, 
0.999973, 0.999974, 0.999976, 0.999978, 0.99998, 0.999981, 0.999983, 
0.999985,
};


#define FREQUENCY(pitch) pgm_read_float_near(&frequencies[pitch])
#define CONTROL_RATE 64

#include <MozziGuts.h>
#include <Oscil.h>
#include <MetaOscil.h>
#include <tables/sin1024_int8.h>

Oscil<SIN1024_NUM_CELLS, AUDIO_RATE> sine1(SIN1024_DATA);
Oscil<SIN1024_NUM_CELLS, AUDIO_RATE> sine2(SIN1024_DATA);
Oscil<SIN1024_NUM_CELLS, AUDIO_RATE> sine3(SIN1024_DATA);
Oscil<SIN1024_NUM_CELLS, AUDIO_RATE> sine4(SIN1024_DATA);

int16_t nextSine = 0;

#define NUM_SINES 4 
Oscil<SIN1024_NUM_CELLS, AUDIO_RATE> sines[4] = 
    { 
    sine1, sine2, sine3, sine4, 
    };

int32_t gains[NUM_SINES];


#define CV_POT_IN1    A2    // Note In, Pitch Scaling
#define CV_POT_IN2    A1    // Release
#define CV_POT3       A0    // Choice of Droplets
#define CV_IN3        A3   	// Gain?
#define CV_AUDIO_IN   A4    // Pitch Tune
#define CV_AUDIO_OUT  9     // Out
#define CV_GATE_OUT   8     // Trigger
#define RANDOM_PIN    A5


void setup() 
    {
    // some reasonable initial defaults
	pinMode(CV_GATE_OUT, INPUT);
    initializeFrequency(CV_POT_IN1, CV_AUDIO_IN);
    randomSeed(RANDOM_PIN);
    startMozzi();
    }

#define MEDIAN_OF_THREE(a,b,c) (((a) <= (b)) ? (((b) <= (c)) ? (b) : (((a) < (c)) ? (c) : (a))) : (((a) <= (c)) ? (a) : (((b) < (c)) ? (c) : (b))))
uint16_t pitchCV;
uint16_t tuneCV;
uint16_t pA;
uint16_t pB;
void initializeFrequency(uint8_t pitch, uint8_t tune)
	{
	pitchCV = mozziAnalogRead(pitch);
	tuneCV = mozziAnalogRead(tune);
	}
	
#define TRANSPOSE_SEMITONES 0
#define TRANSPOSE_OCTAVES 0
#define LARGE_JUMP 32
#define SEMITONE 17
#define FREQ_COUNTER_MAX 4
uint8_t freqCounter = 0;
inline float getFrequency(uint8_t pitch, uint8_t tune)
	{
    tuneCV = (tuneCV * 15 + mozziAnalogRead(tune)) >> 4;
    uint16_t p = mozziAnalogRead(pitch);

    uint16_t diff = (p > pitchCV ? p - pitchCV : pitchCV - p);
    if (diff >= LARGE_JUMP)
    	{
    	pitchCV = p;		// jump right there
    	freqCounter = FREQ_COUNTER_MAX;
    	}
    else if (freqCounter > 0)
    	{
    	freqCounter--;
    	pitchCV = (pitchCV + p) >> 1;
    	pB = pA;
    	pA = pitchCV;
    	}
    else
    	{
    	uint16_t p1 = MEDIAN_OF_THREE(p, pA, pB);
    	pB = pA;
    	pA = p;
    	pitchCV = (pitchCV * 7 + p1) >> 3;
    	}
    uint16_t finalPitch = pitchCV + (tuneCV >> 1) + TRANSPOSE_SEMITONES * 17 + TRANSPOSE_OCTAVES * 205;
    return FREQUENCY(finalPitch > 1535 ? 1535 : finalPitch);
    }


// Relative frequency ratios for each semitone
PROGMEM const float semitoneFrequencyRatios[] = 
    {
	1.0,
	1.0594630943592953,
	1.122462048309373,
	1.189207115002721,
	1.2599210498948732,
	1.3348398541700344,
	1.4142135623730951,
	1.4983070768766815,
	1.5874010519681994,
	1.681792830507429,
	1.7817974362806785,
	1.8877486253633868,
	2.0,
	2.1189261887185906,
	2.244924096618746,
	2.378414230005442,
	2.5198420997897464,
	2.6696797083400687,
	2.8284271247461903,
	2.996614153753363,
	3.1748021039363987,
	3.363585661014858,
	3.563594872561357,
	3.7754972507267737,
	4.0,
	4.237852377437181,
	4.489848193237492,
	4.756828460010884,
	5.039684199579493,
	5.3393594166801375,
	5.656854249492381,
	5.993228307506726,
	6.3496042078727974,
	6.727171322029716,
	7.127189745122714,
	7.550994501453547,
	8.0,
	8.475704754874362,
	8.979696386474984,
	9.513656920021768,
	10.079368399158986,
	10.678718833360275,
	11.313708498984761,
	11.986456615013452,
	12.699208415745595,
	13.454342644059432,
	14.254379490245428,
	15.101989002907095,
	16.0,
	16.951409509748725,
	17.95939277294997,
	19.027313840043536,
	20.15873679831797,
	21.35743766672055,
	22.627416997969522,
	23.972913230026904,
	25.39841683149119,
	26.908685288118864,
	28.508758980490857,
	30.20397800581419,
	32.0,
	33.90281901949745,
	35.91878554589994,
	38.05462768008707,
	40.31747359663594,
	42.7148753334411,
	45.254833995939045,
	47.94582646005381,
	50.79683366298238,
	53.81737057623773,
	57.01751796098171,
	60.40795601162838,
	};


#define _C (0)
#define _Db (1)
#define _D (2)
#define _Eb (3)
#define _E (4)
#define _F (5)
#define _Gb (6)
#define _G (7)
#define _Ab (8)
#define _A (9)
#define _Bb (10)
#define _B (11)

#define _C1 (_C + 12)
#define _Db1 (_Db + 12)
#define _D1 (_D +  12)
#define _Eb1 (_Eb + 12)
#define _E1 (_E + 12)
#define _F1 (_F + 12)
#define _Gb1 (_Gb + 12)
#define _G1 (_G + 12)
#define _Ab1 (_Ab + 12)
#define _A1 (_A + 12)
#define _Bb1 (_Bb + 12)
#define _B1 (_B + 12)

#define _C2 (_C + 24)
#define _Db2 (_Db + 24)
#define _D2 (_D +  24)
#define _Eb2 (_Eb + 24)
#define _E2 (_E + 24)
#define _F2 (_F + 24)
#define _Gb2 (_Gb + 24)
#define _G2 (_G + 24)
#define _Ab2 (_Ab + 24)
#define _A2 (_A + 24)
#define _Bb2 (_Bb + 24)
#define _B2 (_B + 24)

#define _C3 (_C + 36)
#define _Db3 (_Db + 36)
#define _D3 (_D +  36)
#define _Eb3 (_Eb + 36)
#define _E3 (_E + 36)
#define _F3 (_F + 36)
#define _Gb3 (_Gb + 36)
#define _G3 (_G + 36)
#define _Ab3 (_Ab + 36)
#define _A3 (_A + 36)
#define _Bb3 (_Bb + 36)
#define _B3 (_B + 36)

#define _C4 (_C + 48)
#define _Db4 (_Db + 48)
#define _D4 (_D +  48)
#define _Eb4 (_Eb + 48)
#define _E4 (_E + 48)
#define _F4 (_F + 48)
#define _Gb4 (_Gb + 48)
#define _G4 (_G + 48)
#define _Ab4 (_Ab + 48)
#define _A4 (_A + 48)
#define _Bb4 (_Bb + 48)
#define _B4 (_B + 48)

#define _C5 (_C + 60)


#define NUM_CHORDS 12
#define NUM_NOTES 16

uint8_t chord = 0;
uint8_t lastPitch = 17;	// something bigger than notes
PROGMEM const float chords[NUM_CHORDS][NUM_NOTES] = 
	{
{_C, _C, _C, _E, _G, _C1, _E1, _G1, _C2, _E2, _G2, _C3, _E3, _G3, _C4},			// Maj
{_C, _C, _C, _Eb, _G, _C1, _Eb1, _G1, _C2, _Eb2, _G2, _C3, _Eb3, _G3, _C4},		// min
{_C, _C, _C, _E, _G, _B, _C1, _E1, _G1, _B1, _C2, _E2, _G2, _B2, _C3 },			// Maj7
{_C, _C, _C, _Eb, _G, _Bb, _C1, _Eb1, _G1, _Bb1, _C2, _Eb2, _G2, _Bb2, _C3 },	// min7
{_C, _C, _C, _E, _G, _Bb, _C1, _Eb, _G1, _Bb1, _C2, _Eb, _G2, _Bb2, _C3 },		// 7
{_C, _C, _C, _Eb, _Gb, _A, _C1, _Eb, _Gb1, _A1, _C2, _Eb, _Gb2, _A, _C3 },		// dim7
{_C, _C, _C, _E, _Ab, _C1, _E, _Ab1, _C2, _E, _Ab2, _C3, _E, _Ab2, _C4 },		// Aug7
{_C, _D, _G, _A, _C1, _D2, _E2, _G2, _A2, _C3, _D3, _E3, _G3, _A3, _C4 },		// Pentatonic
{_C, _C, _C, _D, _E, _Gb, _Ab, _Bb, _C1, _D1, _E1, _Gb1, _Ab1, _Bb1, _C2},		// Whole Tone
{_C, _C, _C, _Db, _D, _Eb, _E, _F, _Gb, _G, _Ab, _A, _Bb, _B, _C2 },			// Chromatic
{_C, _G, _C1, _G2, _C2, _G2, _C3, _G3, _C4, _G, _C1, _G2, _C2, _G3, _C3 },		// 5 + Oct
{_C, _C, _C, _C1, _C2, _C3, _C4, _C1, _C2, _C3, _C4, _C1, _C2, _C3, _C4 },		// Oct
	};
	
#define NYQUIST 16384
float baseFrequency;
uint8_t overallGain;

#define SEMITONE_FREQUENCY_RATIOS(pitch) pgm_read_float_near(&semitoneFrequencyRatios[pitch])

#define CHORDS(c,n) pgm_read_float_near(&chords[c][n])



uint8_t release;
uint8_t triggered = false;
uint8_t odd = 0;

void updateControl() 
    {
	if (odd)
	{
	baseFrequency = getFrequency(CV_POT_IN1, CV_AUDIO_IN);

	// Not sure we should bother filtering these, probably not
	chord = (mozziAnalogRead(CV_POT3) * NUM_CHORDS) >> 10;
	
	uint8_t releaseAndCut = (mozziAnalogRead(CV_POT_IN2) * 15) >> 10;
	if (releaseAndCut < 5)
		{
		release = releaseAndCut;
		overallGain = 2;
		}
	else if (releaseAndCut < 10)
		{
		release = releaseAndCut - 5;
		overallGain = 3;
		}
	else
		{
		release = releaseAndCut - 10;
		overallGain = 4;
		}
	}
	
	// Check for a trigger
	uint8_t tr = digitalRead(CV_GATE_OUT);
	if (!triggered && tr)
		{
		trigger();
		triggered = 1;
		}
	else if (!tr)
		{
		triggered = 0;
		}
	odd = !odd;
    }

uint16_t countIn[NUM_SINES];
int16_t _gains[4];
uint8_t _max[4];
uint8_t _counters[4];
uint8_t releases[5] = { 16, 32, 64, 128, 255 };
void trigger()
	{
	// Determine the note, hence the frequency
	uint8_t note;
	float frequency = baseFrequency;		// a reasonable default
	uint8_t pitch;
	for(uint8_t i = 0; i < 16; i++)
		{
		while(true)
			{
			note = random(NUM_NOTES);
			pitch = CHORDS(chord, note); // chords[chord][note];
			if (pitch != lastPitch) break;
			}
		float f = SEMITONE_FREQUENCY_RATIOS(pitch);
		if (baseFrequency * f < NYQUIST) { frequency = f; break; }
		}
	lastPitch = pitch;
		
	// Set things up
	// If we're at zero volume, let's reset.  I'm worried that if we reset at a larger volume we'll click.
	countIn[nextSine] = 7;	// because we increase by 8 and want to end at 255
	_gains[nextSine] = 127;
	sines[nextSine].setPhase(0);
	sines[nextSine].setFreq(frequency * baseFrequency);
	_counters[nextSine] = _max[nextSine] = releases[release];
	nextSine++;
	if (nextSine >= NUM_SINES) 
		nextSine = 0;
	}


inline int32_t attenuate(uint8_t i, int8_t in)
	{
	if (countIn[i] < 256 - 8) countIn[i]+=8;
	if (_counters[i] == 0)
		{
		if (_gains[i] > 0) _gains[i]--;
		_counters[i] = _max[i];
		}
	else
		{
		_counters[i]--;
		}
	return (in * _gains[i] * (int32_t)countIn[i]) >> 8;
	}
	

// Gain should go 1...4
int updateAudio()    
    {
    int16_t a = (
    	+ attenuate(0, (sines[0].next()))
    	+ attenuate(1, (sines[1].next()))
    	+ attenuate(2, (sines[2].next()))
    	+ attenuate(3, (sines[3].next())) * overallGain) >> 1;

    return MonoOutput::from16Bit(a);
    }


void loop() 
    {
    audioHook();
    }
